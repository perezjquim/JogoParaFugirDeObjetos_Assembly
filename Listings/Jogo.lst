A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     1


MACRO ASSEMBLER A51 V8.2.5.0
OBJECT MODULE PLACED IN .\Objects\Jogo.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE Jogo.a51 SET(SMALL) DEBUG PRINT(.\Listings\Jogo.lst) OBJECT(.\Objects\J
                      ogo.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;*******************************************************************************

                       2     ; Projeto 3 de Arquitetura de Computadores

                       3     ; Jogo para fugir de objetos (Assembly)

                       4     ; Manuel Joaquim Andrade Sousa Perez, 2029015

                       5     ; Cláudio Ascenso Sardinha, 2030215

                       6     ;*******************************************************************************

                       7     

                       8     ;*******************************************************************************

                       9     ;       Portas

  00B0                10     INPUT EQU P3

                      11     ;*******************************************************************************

                      12     ; Constantes auxiliares (microcontrolador)

  0064                13     STACK_POINTER_INICIAL EQU 100                                           ; Posição inicial d
                             a stack pointer

  003C                14     TEMPO_T0_HIGH EQU 0x3C                                                                  ; B
                             yte mais significativo do timer 0 - 50 ms (12MHz)

  00AF                15     TEMPO_T0_LOW EQU 0xAF                                                                      
                                  ; Byte menos significativo do timer 0 - 50 ms (12MHz)

  0070                16     TEMPO_T1 EQU 0x70                                                                          
                                                  ; 0x70 Tempo do timer 1 - 112 us (12MHz)

  00FF                17     VAZIO EQU 0xFF                                                                             
                                                                  ; Porta vazia (tudo desligado)

  008F                18     INTERRUPCOES_SETUP EQU 143                                              ; Estado das interr
                             upções ao ser corrido o programa

                      19     ;*******************************************************************************

                      20     ;       Constantes auxiliares (jogo)

  0005                21     IMAGEM_GAMEOVER EQU 5                                                                   ; I
                             D da imagem do gameover

  0006                22     IMAGEM_VICTORY EQU 6                                                                       
                                          ; ID da imagem da vitória

  0007                23     NR_IMAGENS EQU 7                                                                           
                                                          ; Número de imagens

  0007                24     NR_LINHAS EQU 7                                                                            
                                                          ; Número total de linhas

  0006                25     POS_JOGADOR EQU 6                                                                          
                                                  ; Linha do jogador (última linha)

  0004                26     POS_JOGADOR_INICIAL EQU 4                                                               ; P
                             osição inicial do jogador (no meio da linha)

  00FE                27     LINHAATIVA_INICIAL EQU 11111110b                                        ; Seleção da primei
                             ra linha

  0001                28     NIVEL_INICIAL EQU 1                                                                        
                                                  ; Nível inicial (nível 1)

  0004                29     VIDAS_INICIAL EQU 4                                                                        
                                                  ; Nº de vidas para o jogador (3 vidas)

  0005                30     DIFICULDADE1 EQU 5                                                                         
                                          ; Velocidade a que descem os obstáculos (dificuldade)

  0004                31     DIFICULDADE2 EQU 4                                                                         
                                          ; Velocidade a que descem os obstáculos (dificuldade)

  0003                32     DIFICULDADE3 EQU 3                                                                         
                                          ; Velocidade a que descem os obstáculos (dificuldade)

  0002                33     DIFICULDADE4 EQU 2                                                                         
                                          ; Velocidade a que descem os obstáculos (dificuldade)

  0001                34     DIFICULDADE5 EQU 1                                                                         
                                          ; Velocidade a que descem os obstáculos (dificuldade)

  0001                35     LIMITE_X_DIREITA EQU 1                                                                     
                                          ;  Limite direito do display em relação ao X

  0010                36     LIMITE_X_ESQUERDA EQU 16                                                                ; L
A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     2

                             imite esquerdo do display em relação ao X

  0000                37     LINHA_VAZIA EQU 0                                                                          
                                                          ; Representa uma linha vazia (imagem com os LEDs todos desligados)

                      38     ;*******************************************************************************

                      39     ;       Variáveis do jogo

  0028                40     LinhaAtual EQU 40                                                                          
                                                                  ; Variável para guardar o número de linha

  0029                41     VidasRestantes EQU 41                                                                      
                                          ; Vidas restantes do jogador

  002A                42     TempoObstaculos EQU 42                                                                     
                                  ; Tempo (restante) antes de descerem (novamente) os obstáculos

  002B                43     DificuldadeAtual EQU 43                                                                    
                                          ; Dificuldade atual do jogo (tempo estipulado para a frequência com que os obstáculos vão descendo)

  002C                44     ObstaculosInicio EQU 44                                                                    
                                          ; Limite superior dos obstáculos

  002D                45     NivelAtual EQU 45                                                                          
                                                                  ; Nível atual do jogo (que representa a imagem do vetor a ser desenhada)

  002E                46     ImagemAtual EQU 46                                                                         
                                                          ;                       

  002F                47     LinhaAtiva EQU 47                                                                          
                                                                  ;

  0032                48     NovaImagem EQU 50                                                                          
                                                  ; 

  0046                49     ImagemDisplay EQU 70                                                                       
                                          ; Display com 7 valores

                      50     ;*******************************************************************************

                      51     ; Primeira instrução, após o reset do microcontrolador (rotina principal)

----                  52     CSEG AT 0000h

0000 804E             53     JMP Principal

                      54     ;*******************************************************************************

                      55     ;*******************************************************************************

                      56     ; Rotina de tratamento da interrupção externa 0 (mover jogador para a esquerda)

----                  57     CSEG AT 0003h

0003 01C6             58     JMP MoverJogadorEsquerda

                      59     ;*******************************************************************************

                      60     ;*******************************************************************************

                      61     ; Rotina de tratamento da interrupção externa 1 (mover jogador para a direita)

----                  62     CSEG AT 0013h

0013 01E3             63     JMP MoverJogadorDireita

                      64     ;*******************************************************************************

                      65     ; Rotina de tratamento da interrupção do temporizador 0

----                  66     CSEG AT 000bh

000B 2100             67     JMP VerificarObstaculos

                      68     ;*******************************************************************************

                      69     ;*******************************************************************************

                      70     ; Rotina de tratamento da interrupção do temporizador 1 (varrimento do display)

----                  71     CSEG AT 001bh

001B 216C             72     JMP VarrerDisplay

                      73     ;***************************************************************************

                      74     ;***************************************************************************

                      75     

                      76     ;*******************************************************************************        

                      77     ;*******************************************************************************

                      78     ; Rotinas principais

                      79     ;*******************************************************************************

----                  80     CSEG AT 050h

0050                  81     Principal:

0050 758164           82         MOV SP, #STACK_POINTER_INICIAL                              ; Endereço inicial da stack
                              pointer

0053 752800           83         MOV LinhaAtual, #0                                                                     
                                  ; Mostrar a primeira linha no display

0056 752FFE           84         MOV LinhaAtiva, #LINHAATIVA_INICIAL                 ; A primeira linha do display é a p
                             rimeira a ser desenhada

                      85     

0059                  86         LigarInterrupcoes:

                      87             

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     3

                      88                     ; Timer 1 no modo 2 (contador de 8 bits com auto-reload)

                      89                     ; Timer 0 no modo 1 (contador de 16 bits)

0059 758921           90             MOV TMOD, #00100001b                                                               
                                  

                      91                     

005C 758C3C           92             MOV TH0, #TEMPO_T0_HIGH                                                         ; T
                             imer 0 = 50 ms em 50 ms

005F 758AAF           93             MOV TL0, #TEMPO_T0_LOW                                                          ; (
                             este timer vai ser usado para puxar os obstáculos para baixo)

                      94                     

0062 758D70           95             MOV TH1, #TEMPO_T1                                                                 
                                                  ; Timer 1 = 1 segundo

0065 758B70           96             MOV TL1, #TEMPO_T1                                                                 
                                                  ; (este timer vai ser usado para o varrimento do display)

                      97             

0068 75B800           98                     MOV IP, #0                                                                 
                                                                                          ; Não altera as prioridades das interrupções

006B 75A88F           99             MOV IE, #INTERRUPCOES_SETUP                                     ; Activa as interru
                             pções

006E D288            100             SETB IT0                                                                           
                                                                                          ; Ext0 detectada na transição descendente

0070 D28A            101             SETB IT1                                                                           
                                                                                          ; Ext1 detectada na transição descendente

0072 D28C            102             SETB TR0                                                                           
                                                                                          ; Inicia timer 0

0074 D28E            103             SETB TR1                                                                           
                                                                                          ; Inicia timer 1

0076 75B0FF          104             MOV INPUT, #VAZIO                                                                  
                                                          ; Limpeza da porta de entrada (P3)

                     105     

0079                 106         Principal_Jogo:

0079 752904          107                     MOV VidasRestantes, #VIDAS_INICIAL              ; As vidas do jogador são i
                             nicializadas

007C 752D01          108                     MOV NivelAtual, #NIVEL_INICIAL                                   ; Iniciali
                             zação do nível               

                     109             

007F 752B05          110             MOV DificuldadeAtual, #DIFICULDADE1                     ; Muda para a dificuldade d
                             o nível 1

0082 31AA            111             CALL Jogar                                                                         
                                                                                  ; Entra no nível 1

                     112             

0084 752B04          113             MOV DificuldadeAtual, #DIFICULDADE2                     ; Muda para a dificuldade d
                             o nível 2

0087 31AA            114             CALL Jogar                                                                         
                                                                                  ; Entra no nível 2

                     115             

0089 752B03          116             MOV DificuldadeAtual, #DIFICULDADE3                     ; Muda para a dificuldade d
                             o nível 3

008C 31AA            117             CALL Jogar                                                                         
                                                                                  ; Entra no nível 3

                     118             

008E 752B02          119             MOV DificuldadeAtual, #DIFICULDADE4                     ; Muda para a dificuldade d
                             o nível 4

0091 31AA            120             CALL Jogar                                                                         
                                                                                  ; Entra no nível 4

                     121                     

0093 752B01          122             MOV DificuldadeAtual, #DIFICULDADE5                     ; Muda para a dificuldade d
                             o nível 5

0096 31AA            123             CALL Jogar                                                                         
                                                                                  ; Entra no nível 5

                     124                     

                     125                     ; Caso tenha passado pelos níveis todos

                     126                     ; Passa para o modo vitória

0098 219F            127             JMP Victory

                     128     ;*******************************************************************************

                     129     ;*******************************************************************************

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     4

                     130     

                     131     ;*******************************************************************************        

                     132     ;*******************************************************************************

                     133     ; Rotina para desenhar uma imagem no display (obstáculos ou imagem de gameover ou vitória)

                     134     ;*******************************************************************************

009A                 135     DesenharNovaImagem:

009A C0E0            136         PUSH ACC                                                                               
                                                                                  ; Guarda o conteúdo do registo ACC

009C C0F0            137         PUSH B                                                                                 
                                                                                                  ; Guarda o conteúdo do registo B

009E C000            138         PUSH 0                                                                                 
                                                                                                  ; Guarda o conteúdo do registo R0

00A0 C001            139         PUSH 1                                                                                 
                                                                                                  ; Guarda o conteúdo do registo R1

00A2 C002            140         PUSH 2                                                                                 
                                                                                                  ; Guarda o conteúdo do registo R2

                     141     

00A4 E532            142         MOV A, NovaImagem                                                                      
                                                          ; Busca o ID da imagem a ser desenhada (NovaImagem)

00A6 75F007          143         MOV B, #NR_LINHAS                                                                      
                                                  ; Busca o número de linhas

00A9 15F0            144         DEC B                                                                                  
                                                                                                  ; Decrementa o último 
                             valor (visto que não queremos que faça o display na última linha - linha do jogador)

00AB A4              145         MUL AB                                                                                 
                                                                                                  ; Multiplica o ID da i
                             magem pelo tamanho da linha (de forma a obtermos a imagem pretendida)

                     146             

00AC 7846            147         MOV R0, #ImagemDisplay                                                                 
                                          ; Aponta para a imagem apresentada no display

00AE F9              148         MOV R1, A                                                                              
                                                                                  ; Guarda o deslocamento

00AF 7A06            149         MOV R2, #POS_JOGADOR                                                                   
                                          ; Número de linhas do display

00B1 9001D5          150         MOV DPTR, #Imagens                                                                     
                                                  ; Endereço base das imagens

                     151         

                     152             ; Ciclo para desenhar no display

00B4                 153         CicloDesenhar:                                                                         
                                                                          

00B4 93              154             MOVC A, @A+DPTR                                                                    
                                                  ; Busca uma linha da imagem

00B5 F6              155             MOV @R0, A                                                                         
                                                                          ; Desenha essa linha no display

00B6 08              156             INC R0                                                                             
                                                                                          ; Passa para a próxima linha no display

00B7 09              157             INC R1                                                                             
                                                                                          ; Passa para o próxima linha na tabela

00B8 E9              158             MOV A, R1                       

00B9 DAF9            159             DJNZ R2, CicloDesenhar                                                             
                                          ; Verifica se já desenhou em todas as linhas (exceto na linha do jogador)

                     160     

00BB D002            161         POP 2                                                                                  
                                                                                                  ; Repõe o conteúdo do registo R2

00BD D001            162         POP 1                                                                                  
                                                                                                  ; Repõe o conteúdo do registo R1

00BF D000            163         POP 0                                                                                  
                                                                                                  ; Repõe o conteúdo do registo R0

00C1 D0F0            164         POP B                                                                                  
                                                                                                  ; Repõe o conteúdo do registo B

00C3 D0E0            165         POP ACC                                                                                
                                                                                          ; Repõe o conteúddo do registo ACC

00C5 22              166         RET

                     167     ;*******************************************************************************

                     168     ;*******************************************************************************

                     169             

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     5

                     170     ;*******************************************************************************        

                     171     ;*******************************************************************************

                     172     ; Rotinas de interrupção (EXT0 e EXT1) que controlam o movimento do jogador

                     173     ;*******************************************************************************

00C6                 174     MoverJogadorEsquerda:

00C6 C0E0            175             PUSH ACC                                                                           
                                                                                                          ; Guarda o conteúdo do registo ACC

00C8 C0F0            176             PUSH B                                                                             
                                                                                                                  ; Guarda o conteúdo do registo B

00CA C000            177             PUSH 0                                                                             
                                                                                                                  ; Guarda o conteúdo do registo R0

                     178                             

00CC 7406            179             MOV A,#POS_JOGADOR                                                                 
                                                                  ; Aponta para a posição do jogador

00CE 75F046          180             MOV B,#ImagemDisplay                                                               
                                                                  ; Aponta para a imagem apresentada no display

00D1 25F0            181             ADD A,B                                                                            
                                                                                                                  ; Aponta a linha do jogador

00D3 F8              182             MOV R0,A                                                                           
                                                                                                          

00D4 E6              183             MOV A,@R0                                                                          
                                                                                                          ; Guarda a posição do jogador no registo A

                     184             

                     185             ; Caso o jogador não esteja no limite esquerdo do display,

                     186             ; Move para a esquerda

00D5 B41002          187             CJNE A, #LIMITE_X_ESQUERDA, MoverEsquerda       

                     188             

                     189             ; Caso contrário,

                     190             ; Não faz mais nada nesta rotina

00D8 8002            191         JMP FimMoverJogadorEsquerda

                     192         

00DA                 193         MoverEsquerda:

00DA 23              194             RL A                                                                               
                                                                                                                  ; Roda para a esquerda o jogador

00DB F6              195             MOV @R0,A                                                                          
                                                                                                  ; Atualiza a posição do jogador

00DC                 196         FimMoverJogadorEsquerda:

00DC D000            197             POP 0                                                                              
                                                                                                          ; Repõe o conteúdo do registo R0

00DE D0F0            198             POP B                                                                              
                                                                                                          ; Repõe o conteúdo do registo B

00E0 D0E0            199             POP ACC                                                                            
                                                                                                  ; Repõe o conteúdo do registo ACC

00E2 32              200             RETI                                                                               
                                                                                                                  ; Sai da rotina de interrupção

                     201     ;*******************************************************************************

00E3                 202     MoverJogadorDireita:

00E3 C0E0            203             PUSH ACC                                                                           
                                                                                                          ; Guarda o conteúddo do registo ACC

00E5 C0F0            204             PUSH B                                                                             
                                                                                                                  ; Guarda o conteúddo do registo B

00E7 C000            205             PUSH 0                                                                             
                                                                                                                  ; Guarda o conteúddo do registo R0

                     206                             

00E9 7406            207             MOV A,#POS_JOGADOR                                                                 
                                                                  ; Aponta para a posição do jogador

00EB 75F046          208             MOV B,#ImagemDisplay                                                               
                                                                  ; Aponta para a imagem apresentada no display

00EE 25F0            209             ADD A,B                                                                            
                                                                                                                  ; Aponta a linha do jogador

00F0 F8              210             MOV R0,A                                                                           
                                                                                                          

00F1 E6              211             MOV A,@R0                                                                          
                                                                                                          ; Guarda a posição do jogador no registo A

                     212             

                     213             ; Caso o jogador não esteja no limite direito do display,

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     6

                     214             ; Move para a esquerda

00F2 B40102          215             CJNE A, #LIMITE_X_DIREITA, MoverDireita

                     216             

                     217             ; Caso contrário,

                     218             ; Não faz mais nada nesta rotina

00F5 8002            219         JMP FimMoverJogadorDireita

                     220         

00F7                 221         MoverDireita:

00F7 03              222             RR A                                                                               
                                                                                                                  ; Roda para a direita o jogador

00F8 F6              223             MOV @R0,A                                                                          
                                                                                                  ; Atualiza a posição do jogador

                     224                     

00F9                 225         FimMoverJogadorDireita:

00F9 D000            226             POP 0                                                                              
                                                                                                          ; Repõe o conteúdo do registo R0

00FB D0F0            227             POP B                                                                              
                                                                                                          ; Repõe o conteúdo do registo B

00FD D0E0            228             POP ACC                                                                            
                                                                                                  ; Repõe o conteúdo do registo ACC

00FF 32              229             RETI                                                                               
                                                                                                                  ; Sai da rotina de interrupção

                     230     ;*******************************************************************************

                     231     ;*******************************************************************************

                     232      

                     233     ;*******************************************************************************        

                     234     ;*******************************************************************************

                     235     ; Rotina de interrupção (TIMER 0) para puxar os obstáculos

                     236     ;*******************************************************************************

0100                 237     VerificarObstaculos:

0100 C0E0            238         PUSH ACC                                                                               
                                                                                          ; Guarda o conteúdo do registo ACC

0102 C000            239             PUSH 0                                                                             
                                                                                                          ; Guarda o conteúdo do registo R0

0104 C001            240             PUSH 1                                                                             
                                                                                                          ; Guarda o conteúdo do registo R1

0106 C002            241             PUSH 2

0108 C0F0            242         PUSH B                                                                                 
                                                                                                          ; Guarda o conteúdo do registo B

                     243         

010A 758C3C          244         MOV TH0, #TEMPO_T0_HIGH                                                                
                                          ; Reinicializa o timer 0

010D 758AAF          245         MOV TL0, #TEMPO_T0_LOW                                              

                     246     

                     247             ; Decrementa o tempo restante para o movimento dos obstáculos

                     248             ; Verifica se este já acabou (se os obstáculos já se podem mover)

0110 D52A4E          249         DJNZ TempoObstaculos, fimVerificarObstaculos

                     250         

                     251             ; Caso tenha acabado o tempo, reinicializa o tempo de contagem até que sejam movido
                              outra vez

0113                 252         ReinicializarDificuldade:

0113 852B2A          253             MOV TempoObstaculos, DificuldadeAtual

                     254             

                     255             ; Verifica se houve colisão entre o jogador e um obstáculo

0116                 256         VerificarColisoes:

0116 7446            257                     MOV A, #ImagemDisplay                                                      
                                                          ; Aponta para a imagem presente no display

0118 2406            258                     ADD A, #POS_JOGADOR                                                        
                                                          ; Aponta para a linha do jogador

011A F5F0            259             MOV B, A

011C 15F0            260             DEC B                                                                              
                                                                                                  ; Aponta para a linha acima do jogador

                     261             

011E F8              262             MOV R0, A                                                                          
                                                                                          

011F E6              263             MOV A, @R0                                                                         
A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     7

                                                                                  ; Busca a imagem da linha do jogador

0120 A8F0            264             MOV R0, B

0122 86F0            265             MOV B, @R0                                                                         
                                                                                  ; Busca a imagem da linha acima do jogador

                     266                     

0124 55F0            267                     ANL A, B                                                                   
                                                                                                          ; Faz a operaç
                             ão (bitwise) AND de ambas as linhas

                     268                     

                     269                     ; Caso não tenha havido interseção (colisão)

                     270                     ; Simplesmente move os obstáculos

0126 6002            271                     JZ MoverObstaculos

                     272             

                     273                     ; Caso contrário,

                     274                     ; Decrementa o nº de vidas

                     275                     ; E move os obstáculos

0128                 276             DecrementarVidas:

0128 1529            277                             DEC VidasRestantes

                     278     

012A                 279             MoverObstaculos:

012A 7406            280                     MOV A, #POS_JOGADOR             ;i = POS_JOGADOR -1

012C 14              281                     DEC A

                     282                     

012D                 283                     CicloMoverObstaculos:

012D 852CF0          284                             MOV B, ObstaculosInicio

0130 B5F002          285                             CJNE A, B, MoverObstaculosBaixo ; (i != ObstaculosInicio)?

0133 8015            286                             JMP VerificaObstaculosInicio

                     287                     

0135                 288                 MoverObstaculosBaixo:          

0135 F9              289                     MOV R1, A

                     290                     

0136 7446            291                     MOV A, #ImagemDisplay

0138 29              292                     ADD A, R1

                     293                     ;ImagemDisplay[i]

                     294                     

0139 F5F0            295                     MOV B, A

013B 15F0            296                     DEC B

                     297                     ;ImagemDisplay[i-1]

                     298                     

013D FA              299                     MOV R2, A

013E A8F0            300                     MOV R0, B

0140 E6              301                     MOV A, @R0

                     302                     ;Valor de ImagemDisplay[i-1]

                     303                     

0141 8AF0            304                     MOV B, R2

0143 A8F0            305                     MOV R0, B

                     306                     ;MOV R0, R2

                     307                     

0145 F6              308                     MOV @R0, A

                     309                 

                     310             

0146 E9              311                     MOV A, R1

0147 14              312                     DEC A ;i--

                     313                     

0148 80E3            314                     JMP CicloMoverObstaculos

                     315     

014A                 316             VerificaObstaculosInicio:

014A E52C            317                 MOV A, ObstaculosInicio

                     318                  

014C 75F007          319                 MOV B, #NR_LINHAS

014F 15F0            320                 DEC B

                     321                  

0151 B5F002          322                 CJNE A, B, IncrementaObstaculosInicio ; (ObstaculosInicio != NR_LINHAS - 1) ?

0154 800B            323                 JMP FimVerificarObstaculos

                     324         

0156                 325                 IncrementaObstaculosInicio:

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     8

0156 7446            326                     MOV A, #ImagemDisplay

0158 252C            327                     ADD A, ObstaculosInicio

015A F8              328                     MOV R0, A

                     329                      

015B 7400            330                     MOV A, #LINHA_VAZIA

                     331                      

015D F6              332                     MOV @R0, A         ;ImagemDisplay[ObstaculosInicio] = LINHA_VAZIA

015E E6              333                     MOV A, @R0

                     334                      

015F 052C            335                     INC ObstaculosInicio   ;ObstaculosInicio++

                     336                     

0161                 337     FimVerificarObstaculos:

0161 D0F0            338         POP B                                                                                  
                                                                                                          ; Repõe o conteúdo do registo B

0163 D002            339             POP 2

0165 D001            340         POP 1                                                                                  
                                                                                                          ; Repõe o conteúdo do registo R1

0167 D000            341         POP 0                                                                                  
                                                                                                          ; Repõe o conteúdo do registo R0

0169 D0E0            342         POP ACC                                                                                
                                                                                                  ; Repõe o conteúdo do registo ACC

016B 32              343         RETI

                     344     ;*******************************************************************************

                     345     ;*******************************************************************************

                     346     

                     347     ;*******************************************************************************

                     348     ;*******************************************************************************

                     349     ; Rotina de interrupção (TIMER 1) para o varrimento do display

                     350     ;*******************************************************************************

016C                 351     VarrerDisplay:

016C C0E0            352         PUSH ACC                                                                               
                                                                                          ; Guarda o conteúdo do registo ACC

016E C000            353         PUSH 0                                                                                 
                                                                                                          ; Guarda o conteúdo do registo R0

                     354     

0170 7446            355             MOV A, #ImagemDisplay                                                              
                                                          ; Aponta para a imagem apresentada no display

0172 2528            356             ADD A, LinhaAtual                                                                  
                                                                                  ; Aponta para a linha a varrer

0174 F8              357             MOV R0, A                                                                          
                                                                                                  

                     358         

0175 E52F            359         MOV A, LinhaAtiva                                                                      
                                                                          ;

                     360             

0177 7590FF          361             MOV P1, #VAZIO                                                                     
                                                                                  ; Desliga a selecção de todas as linhas

017A 86A0            362             MOV P2, @R0                                                                        
                                                                                          ; Actualiza a informação da coluna

017C F590            363             MOV P1, A                                                                          
                                                                                                  ; Selecciona a linha

                     364     

017E 0528            365             INC LinhaAtual                                                                     
                                                                                          ; Passa para a próxima linha

0180 23              366         RL A                                                                                   
                                                                                                                  ;

0181 F52F            367         MOV LinhaAtiva, A                                                                      
                                                                          ;

                     368             

0183 E528            369         MOV A, LinhaAtual                                                                      
                                                                          ;

                     370             

                     371             ; Caso tenha passado por todas as linhas,

                     372             ; Reinicializa os valores de LinhaAtual e LinhaAtiva

0185 B40706          373             CJNE A, #NR_LINHAS, FimVarrerDisplay                                    

0188 752800          374             MOV LinhaAtual, #0                                                                 
A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE     9

                                                                          

018B 752FFE          375         MOV LinhaAtiva, #LINHAATIVA_INICIAL                                         

                     376         

018E                 377         FimVarrerDisplay:

018E D000            378             POP 0                                                                              
                                                                                                  ; Repõe o conteúdo do registo R0

0190 D0E0            379             POP ACC                                                                            
                                                                                          ; Repõe o conteúdo do registo ACC

0192 32              380             RETI

                     381     ;*******************************************************************************

                     382     ;*******************************************************************************        

                     383                     

                     384     ;*******************************************************************************

                     385     ;*******************************************************************************

                     386     ; Rotina que desliga o timer 0 (responsável pelo movimento dos obstáculos)

                     387     ; (usada no fim do jogo, para manter a imagem final intacta)

                     388     ;*******************************************************************************

0193                 389     DesligarInterrupcoes:

0193 C28C            390         CLR TR0                                                                                
                                                                                                  ; Desliga o timer 0

0195 22              391         RET

                     392     ;*******************************************************************************

                     393     ;*******************************************************************************

                     394     

                     395     ;*******************************************************************************

                     396     ;*******************************************************************************

                     397     ; Rotinas para o final do jogo

                     398     ; (Vitória ou Gameover)

                     399     ;*******************************************************************************

0196                 400     GameOver:

0196 753205          401         MOV NovaImagem, #IMAGEM_GAMEOVER                            ; A próxima imagem a ser de
                             senhada é a imagem do gameover

0199 119A            402         CALL DesenharNovaImagem                                                                
                                          ; Desenha essa imagem (gameover)

019B 3193            403         CALL DesligarInterrupcoes                                                              
                                                  ; Desliga o timer 0

019D 8009            404         JMP EndLoop                                                                            
                                                                                  ; Entra em loop

                     405     

019F                 406     Victory:

019F 753206          407         MOV NovaImagem, #IMAGEM_VICTORY                                     ; A próxima imagem 
                             a ser desenhada é a imagem da vitória

01A2 119A            408         CALL DesenharNovaImagem                                                                
                                          ; Desenha essa imagem (vitória)

01A4 3193            409         CALL DesligarInterrupcoes                                                              
                                                  ; Desliga o timer 0

01A6 8000            410         JMP EndLoop                                                                            
                                                                                  ; Entra em loop

                     411     

01A8 80FE            412     EndLoop: JMP EndLoop

                     413     ;*******************************************************************************

                     414     ;*******************************************************************************

                     415     

                     416     ;*******************************************************************************

                     417     ;*******************************************************************************

                     418     ; Rotinas para os níveis do jogo

                     419     ;*******************************************************************************

01AA                 420     Jogar:

01AA 852B2A          421         MOV TempoObstaculos, DificuldadeAtual                               ; Inicializa o temp
                             o entre cada movimento dos obstáculos

                     422         

01AD                 423         InicializarJogador:

01AD 7446            424             MOV A, #ImagemDisplay                                                              
                                                  ; Aponta para a imagem apresentada no display

01AF 2406            425             ADD A, #POS_JOGADOR                                                                
                                                  ; Aponta para a linha do jogador

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE    10

01B1 F8              426             MOV R0, A

01B2 7604            427             MOV @R0, #POS_JOGADOR_INICIAL                                   ; Põe o jogador na 
                             sua posição inicial

                     428             

01B4                 429         InicializarObstaculos:

01B4 752C00          430             MOV ObstaculosInicio, #0                                                           
                                                  ; Limite superior dos obstáculos é inicializado

                     431                     

01B7 A82D            432             MOV R0, NivelAtual                                                                 
                                                                  ; Busca o ID da imagem do nível (obstáculos)

01B9 18              433             DEC R0

                     434                     

01BA 8832            435             MOV NovaImagem, R0                                                                 
                                                          ; Passa a ser a imagem a ser desenhada

01BC 119A            436             CALL DesenharNovaImagem                                                            
                                  ; Desenha os obstáculos

                     437         

01BE                 438         CicloJogar:

01BE E529            439             MOV A, VidasRestantes                                                              
                                                  ; Busca as vidas do jogador

                     440                     

                     441                     ; Caso o jogador já não tenha vidas,

                     442                     ; Sai do ciclo

01C0 600A            443             JZ fimCicloJogar

                     444                     

01C2 E52C            445             MOV A, ObstaculosInicio                                                            
                                                  ; Busca o limite superior dos obstáculos

01C4 75F007          446             MOV B, #NR_LINHAS                                                                  
                                                          ; Busca o número de linhas

01C7 15F0            447             DEC B

                     448                     

                     449                     ; Caso os obstáculos não tenham chegado todos ao fim,

                     450                     ; Continua o ciclo

01C9 B5F0F2          451             CJNE A, B, CicloJogar

                     452             

01CC                 453         fimCicloJogar:    

01CC E529            454             MOV A, VidasRestantes                                                              
                                                  ; Busca o número de vidas restantes

                     455                     

                     456                     ; Caso o jogador ainda tenha vidas,

                     457                     ; Passa para o próximo nível

01CE 7002            458             JNZ ProximoNivel

                     459                     

                     460                     ; Caso contrário,

                     461                     ; Passa para o Gameover

01D0 80C4            462             JMP GameOver

                     463         

01D2                 464         ProximoNivel:

01D2 052D            465             INC NivelAtual                                                                     
                                                                                  ; Incrementa o nº do nível

01D4 22              466             RET

                     467     ;*******************************************************************************

                     468     ;*******************************************************************************

                     469     ; Imagens a mostrar no display

01D5                 470     Imagens:

01D5 03020401        471     DB 3, 2, 4, 1, 5, 2             ; Nível 1

01D9 0502                    
01DB 04030206        472     DB 4, 3, 2, 6, 0, 0             ; Nível 2

01DF 0000                    
01E1 07060206        473     DB 7, 6, 2, 6, 0, 0             ; Nível 3

01E5 0000                    
01E7 08020306        474     DB 8, 2, 3, 6, 0, 0             ; Nível 4

01EB 0000                    
01ED 01040406        475     DB 1, 4, 4, 6, 0, 0             ; Nível 5  

01F1 0000                    
01F3 110A040A        476     DB 17,10,4,10,17,0      ; Game over

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE    11

01F7 1100                    
01F9 1F1F1F1F        477     DB 31,31,31,31,31,31    ; Vitória

01FD 1F1F                    
                     478     ;**************************************************************************

                     479     

                     480     END

A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE    12

SYMBOL TABLE LISTING
------ ----- -------


N A M E                     T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . . . . . .  D ADDR   00E0H   A   
B. . . . . . . . . . . . .  D ADDR   00F0H   A   
CICLODESENHAR. . . . . . .  C ADDR   00B4H   A   
CICLOJOGAR . . . . . . . .  C ADDR   01BEH   A   
CICLOMOVEROBSTACULOS . . .  C ADDR   012DH   A   
DECREMENTARVIDAS . . . . .  C ADDR   0128H   A   
DESENHARNOVAIMAGEM . . . .  C ADDR   009AH   A   
DESLIGARINTERRUPCOES . . .  C ADDR   0193H   A   
DIFICULDADE1 . . . . . . .  N NUMB   0005H   A   
DIFICULDADE2 . . . . . . .  N NUMB   0004H   A   
DIFICULDADE3 . . . . . . .  N NUMB   0003H   A   
DIFICULDADE4 . . . . . . .  N NUMB   0002H   A   
DIFICULDADE5 . . . . . . .  N NUMB   0001H   A   
DIFICULDADEATUAL . . . . .  N NUMB   002BH   A   
ENDLOOP. . . . . . . . . .  C ADDR   01A8H   A   
FIMCICLOJOGAR. . . . . . .  C ADDR   01CCH   A   
FIMMOVERJOGADORDIREITA . .  C ADDR   00F9H   A   
FIMMOVERJOGADORESQUERDA. .  C ADDR   00DCH   A   
FIMVARRERDISPLAY . . . . .  C ADDR   018EH   A   
FIMVERIFICAROBSTACULOS . .  C ADDR   0161H   A   
GAMEOVER . . . . . . . . .  C ADDR   0196H   A   
IE . . . . . . . . . . . .  D ADDR   00A8H   A   
IMAGEMATUAL. . . . . . . .  N NUMB   002EH   A   
IMAGEMDISPLAY. . . . . . .  N NUMB   0046H   A   
IMAGEM_GAMEOVER. . . . . .  N NUMB   0005H   A   
IMAGEM_VICTORY . . . . . .  N NUMB   0006H   A   
IMAGENS. . . . . . . . . .  C ADDR   01D5H   A   
INCREMENTAOBSTACULOSINICIO  C ADDR   0156H   A   
INICIALIZARJOGADOR . . . .  C ADDR   01ADH   A   
INICIALIZAROBSTACULOS. . .  C ADDR   01B4H   A   
INPUT. . . . . . . . . . .  D ADDR   00B0H   A   
INTERRUPCOES_SETUP . . . .  N NUMB   008FH   A   
IP . . . . . . . . . . . .  D ADDR   00B8H   A   
IT0. . . . . . . . . . . .  B ADDR   0088H.0 A   
IT1. . . . . . . . . . . .  B ADDR   0088H.2 A   
JOGAR. . . . . . . . . . .  C ADDR   01AAH   A   
LIGARINTERRUPCOES. . . . .  C ADDR   0059H   A   
LIMITE_X_DIREITA . . . . .  N NUMB   0001H   A   
LIMITE_X_ESQUERDA. . . . .  N NUMB   0010H   A   
LINHAATIVA . . . . . . . .  N NUMB   002FH   A   
LINHAATIVA_INICIAL . . . .  N NUMB   00FEH   A   
LINHAATUAL . . . . . . . .  N NUMB   0028H   A   
LINHA_VAZIA. . . . . . . .  N NUMB   0000H   A   
MOVERDIREITA . . . . . . .  C ADDR   00F7H   A   
MOVERESQUERDA. . . . . . .  C ADDR   00DAH   A   
MOVERJOGADORDIREITA. . . .  C ADDR   00E3H   A   
MOVERJOGADORESQUERDA . . .  C ADDR   00C6H   A   
MOVEROBSTACULOS. . . . . .  C ADDR   012AH   A   
MOVEROBSTACULOSBAIXO . . .  C ADDR   0135H   A   
NIVELATUAL . . . . . . . .  N NUMB   002DH   A   
NIVEL_INICIAL. . . . . . .  N NUMB   0001H   A   
NOVAIMAGEM . . . . . . . .  N NUMB   0032H   A   
NR_IMAGENS . . . . . . . .  N NUMB   0007H   A   
NR_LINHAS. . . . . . . . .  N NUMB   0007H   A   
OBSTACULOSINICIO . . . . .  N NUMB   002CH   A   
P1 . . . . . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . . . . . .  D ADDR   00B0H   A   
POS_JOGADOR. . . . . . . .  N NUMB   0006H   A   
POS_JOGADOR_INICIAL. . . .  N NUMB   0004H   A   
A51 MACRO ASSEMBLER  JOGO                                                                 06/02/2017 00:45:43 PAGE    13

PRINCIPAL. . . . . . . . .  C ADDR   0050H   A   
PRINCIPAL_JOGO . . . . . .  C ADDR   0079H   A   
PROXIMONIVEL . . . . . . .  C ADDR   01D2H   A   
REINICIALIZARDIFICULDADE .  C ADDR   0113H   A   
SP . . . . . . . . . . . .  D ADDR   0081H   A   
STACK_POINTER_INICIAL. . .  N NUMB   0064H   A   
TEMPOOBSTACULOS. . . . . .  N NUMB   002AH   A   
TEMPO_T0_HIGH. . . . . . .  N NUMB   003CH   A   
TEMPO_T0_LOW . . . . . . .  N NUMB   00AFH   A   
TEMPO_T1 . . . . . . . . .  N NUMB   0070H   A   
TH0. . . . . . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . . . . . .  D ADDR   008DH   A   
TL0. . . . . . . . . . . .  D ADDR   008AH   A   
TL1. . . . . . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . . . . . .  B ADDR   0088H.6 A   
VARRERDISPLAY. . . . . . .  C ADDR   016CH   A   
VAZIO. . . . . . . . . . .  N NUMB   00FFH   A   
VERIFICAOBSTACULOSINICIO .  C ADDR   014AH   A   
VERIFICARCOLISOES. . . . .  C ADDR   0116H   A   
VERIFICAROBSTACULOS. . . .  C ADDR   0100H   A   
VICTORY. . . . . . . . . .  C ADDR   019FH   A   
VIDASRESTANTES . . . . . .  N NUMB   0029H   A   
VIDAS_INICIAL. . . . . . .  N NUMB   0004H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
